  testSignalBtn.addEventListener('click', () => {
    const guess = parseInt(userGuessInput.value.trim(), 10);
    if (isNaN(guess)) {
      resultsDiv.textContent = "Please enter a valid number.";
      return;
    }

    // Determine actual prime value for this index
    const actualPrime = selectedPrime;
    const absoluteDiff = Math.abs(guess - actualPrime);
    const relativeAccuracy = 100 - Math.min(100, (absoluteDiff / actualPrime) * 100);

    // Show feedback
    resultsDiv.innerHTML = `
      <p>Actual Prime: <strong>${actualPrime}</strong></p>
      <p>Your Guess: <strong>${guess}</strong></p>
      <p>Accuracy: <strong>${relativeAccuracy.toFixed(2)}%</strong></p>
      <p>Delta: <strong>${absoluteDiff}</strong></p>
    `;
    resultsSection.style.display = "block";

    // Save to history
    const timestamp = new Date().toLocaleString();
    sessionHistory.push({
      stage: stages[currentStage].name,
      index: selectedPrimeIndex,
      actual: actualPrime,
      guess: guess,
      accuracy: relativeAccuracy.toFixed(2),
      time: timestamp
    });
    localStorage.setItem('niceSessionHistory', JSON.stringify(sessionHistory));

    updateHistoryUI();
    drawTrendChart();
  });

  function updateHistoryUI() {
    if (sessionHistory.length === 0) {
      historyContainer.textContent = "No sessions recorded yet.";
      return;
    }

    historyContainer.innerHTML = sessionHistory.slice(-10).reverse().map(s =>
      `<div><strong>${s.time}</strong>: Stage <em>${s.stage}</em>, index ${s.index}, guess ${s.guess}, accuracy ${s.accuracy}%</div>`
    ).join("");
  }

  function drawTrendChart() {
    const ctx = trendCanvas.getContext("2d");
    ctx.clearRect(0, 0, trendCanvas.width, trendCanvas.height);

    const padding = 20;
    const width = trendCanvas.width;
    const height = trendCanvas.height;

    const points = sessionHistory.slice(-20).map((s, i) => {
      const x = padding + i * ((width - 2 * padding) / 19);
      const y = height - padding - ((parseFloat(s.accuracy) / 100) * (height - 2 * padding));
      return { x, y };
    });

    // Draw line
    ctx.beginPath();
    ctx.strokeStyle = "#ffd700";
    ctx.lineWidth = 2;
    points.forEach((p, i) => {
      if (i === 0) ctx.moveTo(p.x, p.y);
      else ctx.lineTo(p.x, p.y);
    });
    ctx.stroke();

    // Draw dots
    ctx.fillStyle = "#ffd700";
    points.forEach(p => {
      ctx.beginPath();
      ctx.arc(p.x, p.y, 4, 0, 2 * Math.PI);
      ctx.fill();
    });
  }

  shareBtn.addEventListener('click', () => {
    const last = sessionHistory[sessionHistory.length - 1];
    if (!last) return;

    const shareText = `ðŸŒŸ NICE Prime Retrieval ðŸŒŸ\nStage: ${last.stage}\nIndex: ${last.index}\nActual: ${last.actual}\nYour Guess: ${last.guess}\nAccuracy: ${last.accuracy}%`;

    navigator.clipboard.writeText(shareText).then(() => {
      alert("Copied to clipboard!");
    }).catch(err => {
      alert("Copy failed.");
    });
  });
